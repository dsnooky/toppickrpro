<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Redirecting to Best Deal‚Ä¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SEO + Security -->
<meta name="robots" content="noindex,nofollow,noarchive">
<meta http-equiv="referrer" content="no-referrer">

<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#0f2027;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
  text-align:center;
}
.loader{
  width:40px;height:40px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid #ffeb3b;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:20px auto;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div>
  <h2>Redirecting to best price‚Ä¶</h2>
  <div class="loader"></div>
  <p>Please wait</p>
</div>

<script>
/* üîê CONFIG */
const SHEET_URL = "PUT_YOUR_CSV_URL_HERE";

/* üîç READ PARAMS */
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");
const platform = params.get("p"); // Shopee | Lazada

if (!productId) {
  document.body.innerHTML = "Invalid product.";
  throw new Error("Missing product ID");
}

/* üß† SAFE CSV PARSER */
function parseCSV(row){
  const out=[];let cur="",q=false;
  for(let i=0;i<row.length;i++){
    const c=row[i];
    if(c=='"'&&row[i+1]=='"'){cur+='"';i++}
    else if(c=='"'){q=!q}
    else if(c==","&&!q){out.push(cur);cur=""}
    else cur+=c;
  }
  out.push(cur);
  return out.map(x=>x.replace(/^"|"$/g,"").trim());
}

/* üöÄ FETCH + REDIRECT */
fetch(SHEET_URL,{cache:"no-store"})
  .then(r=>r.text())
  .then(csv=>{
    const rows = csv.trim().split("\n").slice(1);

    for (const row of rows) {
      const [
        id,
        title,
        category,
        shopeePrice,
        shopeeLink,
        lazadaPrice,
        lazadaLink
      ] = parseCSV(row);

      if (id === productId) {
        let target = null;

        if (platform === "Shopee") target = shopeeLink;
        if (platform === "Lazada") target = lazadaLink;

        if (!target) {
          target = shopeeLink || lazadaLink;
        }

        if (target) {
          // slight delay for tracking pixels if added later
          setTimeout(()=>location.replace(target),300);
          return;
        }
      }
    }

    document.body.innerHTML = "Deal not found.";
  })
  .catch(()=>{
    document.body.innerHTML = "Unable to redirect.";
  });
</script>

</body>
</html>
